<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI PDF Chat with Sessions</title>
  <style>
    /* your CSS remains unchanged, so skip for brevity */
  </style>
</head>
<body>

  <header>
    <div id="welcome-msg">Welcome, <span id="username">{{ username | default('Guest') }}</span>!</div>
    <div>
      <button id="dark-mode-toggle" aria-label="Toggle dark mode" title="Toggle Dark Mode">🌙</button>
      <button id="logout-btn" aria-label="Logout" title="Logout">Logout</button>
    </div>
  </header>

  <div id="container">
    <aside id="sidebar" aria-label="Chat sessions">
      <h2>Chat Sessions</h2>
      <div id="sessions-list" tabindex="0" aria-live="polite" aria-relevant="additions"></div>
      <button id="new-chat-sidebar-btn" title="Start new chat session" aria-label="Start new chat session">New Chat</button>
    </aside>

    <section id="main">
      <div id="controls" aria-label="Chat controls">
        <select id="model-select" title="Select AI Model" aria-label="Select AI Model">
          <option value="models/gemini-2.5-flash" selected>Gemini 2.5 Flash</option>
          <option value="models/gemma-3-12b-it">Gemma 3 12B IT</option>
        </select>

        <input type="file" id="pdf-upload" accept="application/pdf" title="Upload PDF" aria-label="Upload PDF to add context" />

        <label><input type="checkbox" id="use-pdf-toggle" /> Use PDF</label>

        <button id="load-history-btn" type="button" title="Load chat history" aria-label="Load chat history">Load History</button>
      </div>

      <main id="chat" role="main" aria-live="polite" aria-relevant="additions" tabindex="0"></main>

      <form id="chat-form" autocomplete="off" aria-label="Chat input form">
        <input type="text" id="question" placeholder="Ask a question..." required aria-required="true" aria-label="Ask a question" />
        <button type="submit">Send</button>
      </form>
    </section>
  </div>

<script>
  // --- Theme Toggle ---
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    darkModeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
  }
  applyTheme(localStorage.getItem('theme') || 'light');
  darkModeToggle.addEventListener('click', () => {
    applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
  });

  // --- Logout ---
  document.getElementById('logout-btn').addEventListener('click', () => {
    if (confirm("Are you sure you want to logout?")) {
      window.location.href = '/logout';
    }
  });

  // --- Chat Logic ---
  const chat = document.getElementById('chat');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('question');
  const modelSelect = document.getElementById('model-select');
  const pdfUpload = document.getElementById('pdf-upload');
  const loadHistoryBtn = document.getElementById('load-history-btn');
  const newChatSidebarBtn = document.getElementById('new-chat-sidebar-btn');
  const sessionsList = document.getElementById('sessions-list');
  const usePdfToggle = document.getElementById('use-pdf-toggle');

  let pdfUploaded = false;
  let currentSessionId = null;

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.className = 'message ' + sender;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function clearMessages() {
    chat.innerHTML = '';
  }

  async function loadChatSessions(selectLast = true) {
    try {
      const res = await fetch('/api/chat_sessions');
      const sessions = await res.json();
      sessionsList.innerHTML = '';
      if (!sessions.length) {
        currentSessionId = null;
        clearMessages();
        addMessage("No previous chat sessions. Start chatting!", "ai");
        return;
      }
      sessions.forEach((session, idx) => {
        const div = document.createElement('div');
        div.className = 'session-item';
        div.textContent = session.name;
        div.dataset.sessionId = session.id;
        if (selectLast && idx === 0) {
          div.classList.add('active');
          currentSessionId = session.id;
        }
        div.addEventListener('click', () => selectChatSession(session.id, div));
        sessionsList.appendChild(div);
      });
      if (currentSessionId) await loadChatHistory(currentSessionId);
    } catch (err) {
      alert('❌ Error loading chat sessions: ' + err.message);
    }
  }

  function selectChatSession(sessionId, div) {
    if (sessionId === currentSessionId) return;
    currentSessionId = sessionId;
    [...sessionsList.children].forEach(c => c.classList.remove('active'));
    div.classList.add('active');
    clearMessages();
    loadChatHistory(sessionId);
  }

  async function loadChatHistory(sessionId) {
    try {
      const res = await fetch(`/api/history?session_id=${sessionId}`);
      const data = await res.json();
      clearMessages();
      if (Array.isArray(data) && data.length > 0) {
        data.forEach(({ sender, message }) => addMessage(message, sender));
      } else {
        addMessage("Start chatting in this session!", "ai");
      }
    } catch (err) {
      alert('❌ Error loading history: ' + err.message);
    }
  }

  pdfUpload.addEventListener('change', async () => {
    const file = pdfUpload.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('pdf', file);
    try {
      const res = await fetch('/api/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (res.ok) {
        pdfUploaded = true;
        usePdfToggle.checked = true;
        alert('✅ PDF uploaded and processed.');
      } else {
        alert('❌ Upload failed: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('❌ Upload failed.');
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const question = input.value.trim();
    if (!question || !currentSessionId) {
      alert("Please enter a question and ensure a chat session is active.");
      return;
    }

    const model = modelSelect.value;
    const usePdf = usePdfToggle.checked;

    input.disabled = modelSelect.disabled = pdfUpload.disabled = newChatSidebarBtn.disabled = loadHistoryBtn.disabled = true;
    addMessage(question, 'user');
    input.value = '';
    addMessage('🤖 Thinking...', 'ai');

    try {
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, model, use_pdf: usePdf, chat_session_id: currentSessionId })
      });
      const data = await res.json();
      chat.lastChild.remove();
      addMessage(data.answer || ('❌ ' + (data.error || 'No answer')), 'ai');
    } catch (err) {
      chat.lastChild.remove();
      addMessage('❌ Error: ' + err.message, 'ai');
    } finally {
      input.disabled = modelSelect.disabled = pdfUpload.disabled = newChatSidebarBtn.disabled = loadHistoryBtn.disabled = false;
      input.focus();
    }
  });

  newChatSidebarBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/new_chat', { method: 'POST' });
      const data = await res.json();
      if (res.ok) {
        pdfUploaded = false;
        usePdfToggle.checked = false;
        pdfUpload.value = "";
        await loadChatSessions();
        alert(data.message || 'Started a new chat session.');
      } else {
        alert('❌ Failed to start new chat: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('❌ Failed to start new chat: ' + err.message);
    }
  });

  loadHistoryBtn.addEventListener('click', () => {
    if (currentSessionId) loadChatHistory(currentSessionId);
    else alert("No chat session active.");
  });

  window.onload = loadChatSessions;
</script>

</body>
</html>
